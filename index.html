<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–∞</title>
    <style>
        body {
            background: linear-gradient(135deg, #2c3e50, #34495e, #2c3e50);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            margin: 0; min-height: 100vh;
        }
        .header {
            background: rgba(52,73,94,0.9);
            padding: 18px 20px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .game-title { font-size: 22px; font-weight: bold; color: #e74c3c;}
        .balance-block {
            background: rgba(255,255,255,0.08); border-radius: 12px; padding: 10px 16px;
            font-weight: bold; display: flex; align-items: center; gap: 8px;
            border: 1.5px solid rgba(255,255,255,0.1);
        }
        .main {
            display: flex; flex-direction: column; align-items: center;
            margin-top: 80px;
        }
        .case-btn {
            background: linear-gradient(135deg,#f39c12,#e67e22);
            color: white; font-size: 22px; font-weight: bold;
            border: none; border-radius: 18px; padding: 16px 44px;
            cursor: pointer; margin-top: 45px; margin-bottom: 20px;
            transition: background 0.2s;
        }
        .case-btn:active { background: linear-gradient(135deg,#e67e22,#f39c12);}
        .case-result {
            background: rgba(255,255,255,0.14); border-radius: 15px;
            margin-top: 40px; text-align: center;
            padding: 25px 20px; min-width: 220px;
            border: 3px solid #f39c12;
            display: none;
        }
        .case-result img { width: 88px; height: 88px; border-radius: 50%; margin-bottom: 12px;}
        .case-result .name { font-size: 20px; font-weight: bold; margin-bottom: 10px;}
        .case-result .rarity { font-size: 15px; font-weight: 600;}
        .loading { margin-top:60px; font-size:18px;}
        .err { color: #e74c3c; font-size:18px; margin-top:30px;}
    </style>
</head>
<body>
    <div class="header">
        <div class="game-title">Hockey Shootouts</div>
        <div class="balance-block">
            <span>üèí</span>
            <span id="balance">...</span>
            <span>–∫–ª—é—à–µ–∫</span>
        </div>
    </div>
    <div class="main">
        <button class="case-btn" id="openBtn" onclick="openCase()" disabled>–û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å</button>
        <div class="case-result" id="caseResult">
            <img id="caseImg" src="" alt="">
            <div class="name" id="caseName"></div>
            <div class="rarity" id="caseRarity"></div>
        </div>
        <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="err" id="err"></div>
    </div>
    <script>
        // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –º–∞—Å—Å–∏–≤—ã ---
        let API_BASE = window.location.origin;
        const casePrice = 30;
        const casePool = [
            { name: '–ì—Ä–∏—Ü—é–∫', rarity: '–≠–ø–∏—á–µ—Å–∫–∏–π', rarityKey: 'epic' },
            { name: '–ë–∞—Ä—É–ª–∏–Ω', rarity: '–°–≤–µ—Ä—Ö—Ä–µ–¥–∫–∏–π', rarityKey: 'superrare' },
            { name: '–°–µ—Ä–∏–∫–æ–≤', rarity: '–†–µ–¥–∫–∏–π', rarityKey: 'rare' },
            { name: '–ú–∞–º–∏–Ω', rarity: '–≠–ø–∏—á–µ—Å–∫–∏–π', rarityKey: 'epic' },
            { name: '–î—ã–Ω—è–∫', rarity: '–°–≤–µ—Ä—Ö—Ä–µ–¥–∫–∏–π', rarityKey: 'superrare' }
        ];

        function getCookie(name) {
            let m = document.cookie.match('(?:^|; )' + name.replace(/([\\.$?*|{}()\\[\\]\\\\\\/\\+^])/g, '\\$1') + '=([^;]*)');
            return m ? decodeURIComponent(m[1]) : undefined;
        }

        let userId = null, balance = 0;

        // --- –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
        async function fetchUser() {
            userId = getCookie('hockey_user_id');
            if (!userId) return showError('–ù–µ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ cookie');
            try {
                const res = await fetch(`${API_BASE}/api/user/${userId}`);
                if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                const data = await res.json();
                if (!data.user) throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                balance = data.user.balance;
                document.getElementById('balance').textContent = balance;
                document.getElementById('openBtn').disabled = balance < casePrice;
                document.getElementById('loading').style.display = 'none';
            } catch(e) {
                showError(e.message);
            }
        }

        function showError(msg) {
            document.getElementById('err').textContent = msg;
            document.getElementById('loading').style.display = 'none';
        }

        // --- –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–∞ ---
        async function openCase() {
            document.getElementById('err').textContent = '';
            if (balance < casePrice) {
                showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–ª—é—à–µ–∫!');
                return;
            }
            document.getElementById('openBtn').disabled = true;
            // –í—ã–±–æ—Ä –ø—Ä–∏–∑–∞ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω—É—é –ª–æ–≥–∏–∫—É)
            const prize = casePool[Math.floor(Math.random() * casePool.length)];
            // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å (–æ–±—ã—á–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
            try {
                // –°–ø–∏—Å–∞—Ç—å –∫–ª—é—à–∫–∏ (–ø—Ä–∏–º–µ—Ä–Ω–æ, –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ POST –Ω–∞ —Å–µ—Ä–≤–µ—Ä)
                const res = await fetch(`${API_BASE}/api/user/${userId}/open-case`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ price: casePrice, prize: prize.name })
                });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.message || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                balance = data.user.balance;
                document.getElementById('balance').textContent = balance;
            } catch(e) {
                showError('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è: ' + e.message);
                return;
            }
            showPrize(prize);
            document.getElementById('openBtn').disabled = balance < casePrice;
        }

        // --- –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–∑ ---
        function showPrize(card) {
            document.getElementById('caseResult').style.display = 'block';
            document.getElementById('caseImg').src = `https://raw.githubusercontent.com/ChatGPT-Course/Xokkey/main/avatar/${card.name}.jpg`;
            document.getElementById('caseName').textContent = card.name;
            document.getElementById('caseRarity').textContent = card.rarity;
        }

        window.onload = fetchUser;
    </script>
</body>
</html>
