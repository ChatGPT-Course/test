
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Магазин - Hockey Shootouts</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #2c3e50, #34495e, #2c3e50);
            color: white;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .header-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(52, 73, 94, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-button-header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .back-button-header:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
        }

        .game-title {
            font-size: 24px;
            font-weight: bold;
            color: #e74c3c;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .debug-toggle {
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
        }

        .debug-panel {
            position: fixed;
            top: 70px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 10px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            max-width: 350px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            backdrop-filter: blur(10px);
        }

        .shop-container {
            padding: 80px 20px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .balance-display {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .balance-amount {
            font-size: 18px;
            font-weight: bold;
            color: #e74c3c;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .balance-loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #e74c3c;
            animation: spin 1s ease-in-out infinite;
        }

        .mode-toggle {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
        }

        .toggle-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 5px;
        }

        .toggle-btn {
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
        }

        .toggle-btn:not(.active):hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .shop-title {
            font-size: 24px;
            font-weight: bold;
            color: #ecf0f1;
            margin-bottom: 25px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .card-shop-item {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card-avatar-shop {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
            background: rgba(255, 255, 255, 0.1);
        }

        .avatar-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .card-name-shop {
            font-size: 16px;
            font-weight: bold;
            color: #ecf0f1;
            margin-bottom: 6px;
        }

        .card-rarity-shop {
            font-size: 10px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            display: inline-block;
        }

        .rarity-superrare {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .rarity-rare {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .rarity-epic {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }

        .rarity-mythic {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .rarity-legendary {
            background: linear-gradient(135deg, #ffa500, #ffd700);
            color: #000;
        }

        .card-price {
            font-size: 14px;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .buy-button {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .buy-button:hover {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
        }

        .buy-button:disabled {
            background: linear-gradient(135deg, #7f8c8d, #95a5a6);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .sell-button {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .sell-button:hover {
            background: linear-gradient(135deg, #e67e22, #d35400);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        }

        .sell-button:disabled {
            background: linear-gradient(135deg, #7f8c8d, #95a5a6);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #2c3e50, #34495e, #2c3e50);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .loading-container {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #e74c3c;
            animation: spin 1.5s ease-in-out infinite;
            margin: 0 auto 20px;
        }

        .loading-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #e74c3c;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px auto;
        }

        .error-container {
            background: rgba(231, 76, 60, 0.1);
            border: 2px solid #e74c3c;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin: 20px;
            backdrop-filter: blur(10px);
        }

        .error-container h2 {
            color: #e74c3c;
            margin-bottom: 15px;
        }

        /* Модальное окно */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(52, 73, 94, 0.95);
            backdrop-filter: blur(15px);
            margin: 50% auto;
            padding: 25px;
            border-radius: 15px;
            width: 300px;
            max-width: 90%;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transform: translateY(-50%);
        }

        .modal h3 {
            color: #e74c3c;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .modal p {
            margin-bottom: 20px;
            color: #ecf0f1;
            line-height: 1.4;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn-confirm {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .modal-btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #ecf0f1;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 480px) {
            .game-title {
                font-size: 16px;
            }

            .back-button-header {
                padding: 6px 12px;
                font-size: 12px;
            }

            .shop-title {
                font-size: 20px;
            }

            .cards-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .card-shop-item {
                padding: 12px;
            }

            .card-avatar-shop {
                width: 50px;
                height: 50px;
            }

            .modal-content {
                margin: 40% auto;
                padding: 20px;
                width: 280px;
            }
        }
    </style>
</head>
<body>
    <div class="header-panel">
        <a href="index.html" class="back-button-header">
            ← Меню
        </a>
        <div class="game-title">Hockey Shootouts</div>
    </div>

    <div id="debugPanel" class="debug-panel">
        <div id="debugLogs">Инициализация магазина...</div>
    </div>

    <div id="loadingScreen" class="loading-screen">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <h2>Загрузка...</h2>
        </div>
    </div>

    <div id="errorContainer" class="error-container" style="display: none;">
        <h2>❌ Ошибка загрузки</h2>
        <p id="errorMessage">Не удалось загрузить данные магазина</p>
        <button onclick="location.reload()" class="buy-button" style="margin-top: 15px; width: auto; padding: 10px 20px;">
            Повторить
        </button>
    </div>

    <!-- Модальное окно загрузки -->
    <div id="loadingModal" class="loading-modal">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3>Загрузка...</h3>
        </div>
    </div>

    <div id="shopContainer" class="shop-container" style="display: none;">
        <div class="balance-display">
            <div class="balance-amount">
                <span>🏒</span>
                <span>Баланс: </span>
                <span id="userBalance"><div class="balance-loading"></div></span>
                <span> клюшек</span>
            </div>
        </div>

        <div class="mode-toggle">
            <div class="toggle-container">
                <button id="buyModeBtn" class="toggle-btn active" onclick="switchMode('buy')">
                    🛒 Покупка
                </button>
                <button id="sellModeBtn" class="toggle-btn" onclick="switchMode('sell')">
                    💰 Продажа
                </button>
            </div>
        </div>

        <div class="shop-title">
            <span id="shopTitleText">🛒 Магазин карточек</span>
        </div>

        <div id="cardsGrid" class="cards-grid">
            <!-- Карточки будут добавлены через JavaScript -->
        </div>
    </div>

    <!-- Модальное окно подтверждения -->
    <div id="buyModal" class="modal">
        <div class="modal-content">
            <h3>Подтверждение покупки</h3>
            <p id="modalText">Вы уверены, что хотите купить карточку?</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-confirm" onclick="confirmPurchase()">Купить</button>
                <button class="modal-btn modal-btn-cancel" onclick="closeBuyModal()">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно успешной покупки -->
    <div id="successModal" class="modal">
        <div class="modal-content" style="max-width: 250px;">
            <h3 style="color: #27ae60; margin-bottom: 15px;">✅ Карточка куплена!</h3>
            <button class="modal-btn modal-btn-confirm" onclick="closeSuccessModal()" style="width: 100%;">Хорошо</button>
        </div>
    </div>

    <!-- Модальное окно подтверждения продажи -->
    <div id="sellModal" class="modal">
        <div class="modal-content">
            <h3>Подтверждение продажи</h3>
            <p id="sellModalText">Продавая карту, вы обмениваете ее на сумму клюшек.</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-confirm" onclick="confirmSale()">Продать</button>
                <button class="modal-btn modal-btn-cancel" onclick="closeSellModal()">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно успешной продажи -->
    <div id="sellSuccessModal" class="modal">
        <div class="modal-content" style="max-width: 250px;">
            <h3 style="color: #f39c12; margin-bottom: 15px;">💰 Карточка продана!</h3>
            <button class="modal-btn modal-btn-confirm" onclick="closeSellSuccessModal()" style="width: 100%;">Хорошо</button>
        </div>
    </div>

    <script>
        let API_BASE = '';
        let currentUser = null;
        let debugVisible = false;
        let pendingPurchase = null;
        let pendingSale = null;
        let currentMode = 'buy'; // 'buy' или 'sell'
        let userInventory = [];

        // Цены продажи карточек
        const sellPrices = {
            'rare': 8,
            'superrare': 24,
            'epic': 72,
            'mythic': 216,
            'legendary': 648
        };

        // Данные о карточках и их редкости
        const cardsData = {
            'шабанов': { name: 'Шабанов', rarity: 'legendary', rarityText: 'Легендарный' },
            'грицюк': { name: 'Грицюк', rarity: 'epic', rarityText: 'Эпический' },
            'демидов': { name: 'Демидов', rarity: 'mythic', rarityText: 'Мифический' },
            'ткачев_а': { name: 'Ткачев_А', rarity: 'epic', rarityText: 'Эпический' },
            'барабанов': { name: 'Барабанов', rarity: 'epic', rarityText: 'Эпический' },
            'хмелевский': { name: 'Хмелевский', rarity: 'mythic', rarityText: 'Мифический' },
            'абросимов': { name: 'Абросимов', rarity: 'superrare', rarityText: 'Сверхредкий' },
            'аймурзин': { name: 'Аймурзин', rarity: 'epic', rarityText: 'Эпический' },
            'барулин': { name: 'Барулин', rarity: 'superrare', rarityText: 'Сверхредкий' },
            'бикмуллин': { name: 'Бикмуллин', rarity: 'rare', rarityText: 'Редкий' },
            'уильям': { name: 'Уильям', rarity: 'superrare', rarityText: 'Сверхредкий' },
            'бойко': { name: 'Бойко', rarity: 'rare', rarityText: 'Редкий' },
            'бориков': { name: 'Бориков', rarity: 'epic', rarityText: 'Эпический' },
            'брынцев': { name: 'Брынцев', rarity: 'rare', rarityText: 'Редкий' },
            'галимов_арт': { name: 'Галимов_Арт', rarity: 'legendary', rarityText: 'Легендарный' },
            'гераськин': { name: 'Гераськин', rarity: 'superrare', rarityText: 'Сверхредкий' },
            'глотов': { name: 'Глотов', rarity: 'epic', rarityText: 'Эпический' },
            'гутик': { name: 'Гутик', rarity: 'mythic', rarityText: 'Мифический' },
            'данияр': { name: 'Данияр', rarity: 'rare', rarityText: 'Редкий' },
            'демченко': { name: 'Демченко', rarity: 'epic', rarityText: 'Эпический' },
            'дроздов': { name: 'Дроздов', rarity: 'epic', rarityText: 'Эпический' },
            'дыняк': { name: 'Дыняк', rarity: 'superrare', rarityText: 'Сверхредкий' },
            'ильенко': { name: 'Ильенко', rarity: 'epic', rarityText: 'Эпический' },
            'кагарлицкий': { name: 'Кагарлицкий', rarity: 'mythic', rarityText: 'Мифический' },
            'камара': { name: 'Камара', rarity: 'superrare', rarityText: 'Сверхредкий' },
            'капустин': { name: 'Капустин', rarity: 'rare', rarityText: 'Редкий' },
            'кара': { name: 'Кара', rarity: 'epic', rarityText: 'Эпический' },
            'каюмов': { name: 'Каюмов', rarity: 'mythic', rarityText: 'Мифический' },
            'киселевич': { name: 'Киселевич', rarity: 'rare', rarityText: 'Редкий' },
            'классон': { name: 'Классон', rarity: 'superrare', rarityText: 'Сверхредкий' },
            'коновалов': { name: 'Коновалов', rarity: 'rare', rarityText: 'Редкий' },
            'конюшков': { name: 'Конюшков', rarity: 'superrare', rarityText: 'Сверхредкий' },
            'корягин': { name: 'Корягин', rarity: 'rare', rarityText: 'Редкий' },
            'кравцов': { name: 'Кравцов', rarity: 'legendary', rarityText: 'Легендарный' },
            'кузнецов': { name: 'Кузнецов', rarity: 'legendary', rarityText: 'Легендарный' },
            'ли': { name: 'Ли', rarity: 'superrare', rarityText: 'Сверхредкий' },
            'мамин': { name: 'Мамин', rarity: 'epic', rarityText: 'Эпический' },
            'радулов': { name: 'Радулов', rarity: 'legendary', rarityText: 'Легендарный' },
            'локтионов': { name: 'Локтионов', rarity: 'epic', rarityText: 'Эпический' },
            'фу': { name: 'Фу', rarity: 'epic', rarityText: 'Эпический' },
            'сериков': { name: 'Сериков', rarity: 'rare', rarityText: 'Редкий' },
            'ливо': { name: 'Ливо', rarity: 'legendary', rarityText: 'Легендарный' },
            'голдобин': { name: 'Голдобин', rarity: 'mythic', rarityText: 'Мифический' },
            'рушан': { name: 'Рушан', rarity: 'epic', rarityText: 'Эпический' }
        };

        // Все карточки в магазине
        const shopCards = [
            // Редкие (10 клюшек)
            { key: 'сериков', name: 'Сериков', rarity: 'rare', price: 10 },
            { key: 'бикмуллин', name: 'Бикмуллин', rarity: 'rare', price: 10 },
            { key: 'бойко', name: 'Бойко', rarity: 'rare', price: 10 },
            { key: 'брынцев', name: 'Брынцев', rarity: 'rare', price: 10 },
            { key: 'данияр', name: 'Данияр', rarity: 'rare', price: 10 },
            { key: 'капустин', name: 'Капустин', rarity: 'rare', price: 10 },
            { key: 'киселевич', name: 'Киселевич', rarity: 'rare', price: 10 },
            { key: 'коновалов', name: 'Коновалов', rarity: 'rare', price: 10 },
            { key: 'корягин', name: 'Корягин', rarity: 'rare', price: 10 },

            // Сверхредкие (30 клюшек)
            { key: 'абросимов', name: 'Абросимов', rarity: 'superrare', price: 30 },
            { key: 'барулин', name: 'Барулин', rarity: 'superrare', price: 30 },
            { key: 'уильям', name: 'Уильям', rarity: 'superrare', price: 30 },
            { key: 'гераськин', name: 'Гераськин', rarity: 'superrare', price: 30 },
            { key: 'дыняк', name: 'Дыняк', rarity: 'superrare', price: 30 },
            { key: 'камара', name: 'Камара', rarity: 'superrare', price: 30 },
            { key: 'классон', name: 'Классон', rarity: 'superrare', price: 30 },
            { key: 'конюшков', name: 'Конюшков', rarity: 'superrare', price: 30 },
            { key: 'ли', name: 'Ли', rarity: 'superrare', price: 30 },

            // Эпические (90 клюшек)
            { key: 'грицюк', name: 'Грицюк', rarity: 'epic', price: 90 },
            { key: 'ткачев_а', name: 'Ткачев_А', rarity: 'epic', price: 90 },
            { key: 'барабанов', name: 'Барабанов', rarity: 'epic', price: 90 },
            { key: 'аймурзин', name: 'Аймурзин', rarity: 'epic', price: 90 },
            { key: 'бориков', name: 'Бориков', rarity: 'epic', price: 90 },
            { key: 'глотов', name: 'Глотов', rarity: 'epic', price: 90 },
            { key: 'демченко', name: 'Демченко', rarity: 'epic', price: 90 },
            { key: 'дроздов', name: 'Дроздов', rarity: 'epic', price: 90 },
            { key: 'ильенко', name: 'Ильенко', rarity: 'epic', price: 90 },
            { key: 'кара', name: 'Кара', rarity: 'epic', price: 90 },
            { key: 'мамин', name: 'Мамин', rarity: 'epic', price: 90 },
            { key: 'локтионов', name: 'Локтионов', rarity: 'epic', price: 90 },
            { key: 'фу', name: 'Фу', rarity: 'epic', price: 90 },
            { key: 'рушан', name: 'Рушан', rarity: 'epic', price: 90 },

            // Мифические (270 клюшек)
            { key: 'демидов', name: 'Демидов', rarity: 'mythic', price: 270 },
            { key: 'хмелевский', name: 'Хмелевский', rarity: 'mythic', price: 270 },
            { key: 'гутик', name: 'Гутик', rarity: 'mythic', price: 270 },
            { key: 'кагарлицкий', name: 'Кагарлицкий', rarity: 'mythic', price: 270 },
            { key: 'каюмов', name: 'Каюмов', rarity: 'mythic', price: 270 },
            { key: 'голдобин', name: 'Голдобин', rarity: 'mythic', price: 270 },

            // Легендарные (810 клюшек)
            { key: 'шабанов', name: 'Шабанов', rarity: 'legendary', price: 810 },
            { key: 'галимов_арт', name: 'Галимов_Арт', rarity: 'legendary', price: 810 },
            { key: 'кравцов', name: 'Кравцов', rarity: 'legendary', price: 810 },
            { key: 'кузнецов', name: 'Кузнецов', rarity: 'legendary', price: 810 },
            { key: 'радулов', name: 'Радулов', rarity: 'legendary', price: 810 },
            { key: 'ливо', name: 'Ливо', rarity: 'legendary', price: 810 }
        ];

        // Cookie функции
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) {
                    const value = c.substring(nameEQ.length, c.length);
                    addDebugLog(`🍪 Cookie получен: ${name}=${value}`, 'info');
                    return value;
                }
            }
            addDebugLog(`🍪 Cookie не найден: ${name}`, 'warning');
            return null;
        }

        // Debug функции
        function toggleDebug() {
            debugVisible = !debugVisible;
            document.getElementById('debugPanel').style.display = debugVisible ? 'block' : 'none';
        }

        function addDebugLog(message, type = 'info') {
            const debugLogs = document.getElementById('debugLogs');
            const timestamp = new Date().toLocaleTimeString();
            const icons = {
                'success': '✅',
                'error': '❌',
                'info': 'ℹ️',
                'warning': '⚠️'
            };
            const icon = icons[type] || 'ℹ️';
            debugLogs.innerHTML += `[${timestamp}] ${icon} ${message}<br>`;
            debugLogs.scrollTop = debugLogs.scrollHeight;
        }

        function showLoadingScreen() {
            document.getElementById('loadingScreen').style.display = 'flex';
            document.getElementById('shopContainer').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'none';
        }

        function hideLoadingScreen() {
            document.getElementById('loadingScreen').style.display = 'none';
        }

        function showShop() {
            hideLoadingScreen();
            document.getElementById('shopContainer').style.display = 'block';
            document.getElementById('errorContainer').style.display = 'none';
        }

        function showError(message) {
            hideLoadingScreen();
            document.getElementById('shopContainer').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorContainer').style.display = 'block';
        }

        function renderShopCards() {
            const cardsGrid = document.getElementById('cardsGrid');

            const cardsHtml = shopCards.map(card => {
                // Используем имя карточки как есть для GitHub URL
                const imageUrl = `https://raw.githubusercontent.com/ChatGPT-Course/Xokkey/main/avatar/${card.name}.jpg`;
                const buttonId = `buy_${card.key}`;

                return `
                    <div class="card-shop-item">
                        <div class="card-avatar-shop">
                            <img src="${imageUrl}" alt="${card.name}" class="avatar-image" 
                                 onerror="this.style.display='none'; this.parentNode.style.display='flex'; this.parentNode.style.alignItems='center'; this.parentNode.style.justifyContent='center'; this.parentNode.innerHTML='${card.name.charAt(0).toUpperCase()}';">
                        </div>
                        <div class="card-name-shop">${card.name}</div>
                        <div class="card-rarity-shop rarity-${card.rarity}">
                            ${card.rarity === 'rare' ? 'Редкий' : 
                              card.rarity === 'superrare' ? 'Сверхредкий' :
                              card.rarity === 'epic' ? 'Эпический' :
                              card.rarity === 'mythic' ? 'Мифический' : 'Легендарный'}
                        </div>
                        <div class="card-price">
                            <span>🏒</span>
                            <span>${card.price} клюшек</span>
                        </div>
                        <button class="buy-button" onclick="showBuyModal('${card.key}', '${card.name}', ${card.price})" id="${buttonId}">
                            Купить
                        </button>
                    </div>
                `;
            }).join('');

            cardsGrid.innerHTML = cardsHtml;
            addDebugLog(`✅ Отображено карточек в магазине: ${shopCards.length}`, 'success');
        }

        function renderInventoryForSale() {
            const cardsGrid = document.getElementById('cardsGrid');

            if (userInventory.length === 0) {
                cardsGrid.innerHTML = `
                    <div style="
                        grid-column: 1 / -1;
                        text-align: center;
                        padding: 40px;
                        color: rgba(255, 255, 255, 0.6);
                        font-style: italic;
                    ">
                        У вас нет карточек для продажи
                    </div>
                `;
                return;
            }

            const cardsHtml = userInventory.map((card, index) => {
                // Используем имя карточки как есть для GitHub URL
                const imageUrl = `https://raw.githubusercontent.com/ChatGPT-Course/Xokkey/main/avatar/${card.name}.jpg`;
                const buttonId = `sell_${card.key}_${index}`;

                return `
                    <div class="card-shop-item">
                        <div class="card-avatar-shop">
                            <img src="${imageUrl}" alt="${card.name}" class="avatar-image" 
                                 onerror="this.style.display='none'; this.parentNode.style.display='flex'; this.parentNode.style.alignItems='center'; this.parentNode.style.justifyContent='center'; this.parentNode.innerHTML='${card.name.charAt(0).toUpperCase()}';">
                        </div>
                        <div class="card-name-shop">${card.name}</div>
                        <div class="card-rarity-shop rarity-${card.rarity}">
                            ${card.rarityText}
                        </div>
                        <div class="card-price">
                            <span>🏒</span>
                            <span>${card.price} клюшек</span>
                        </div>
                        <button class="sell-button" onclick="showSellModal('${card.key}', '${card.name}', ${card.price})" id="${buttonId}">
                            Продать
                        </button>
                    </div>
                `;
            }).join('');

            cardsGrid.innerHTML = cardsHtml;
            addDebugLog(`✅ Отображено карточек для продажи: ${userInventory.length}`, 'success');
        }

        function updateBalance(balance) {
            const balanceElement = document.getElementById('userBalance');
            balanceElement.textContent = balance;

            // Проверяем доступность кнопок покупки
            shopCards.forEach(card => {
                const button = document.getElementById(`buy_${card.key}`);
                if (button) {
                    if (balance < card.price) {
                        button.disabled = true;
                        button.textContent = 'Мало клюшек';
                    } else {
                        button.disabled = false;
                        button.textContent = 'Купить';
                    }
                }
            });

            addDebugLog(`✅ Баланс обновлен: ${balance}`, 'success');
        }

        function initApiUrl() {
            if (window.location.protocol === 'https:') {
                API_BASE = window.location.origin;
            } else {
                API_BASE = `${window.location.protocol}//${window.location.hostname}:3004`;
            }
            addDebugLog(`🌐 API URL: ${API_BASE}`, 'info');
        }

        // Функция переключения режима
        async function switchMode(mode) {
            currentMode = mode;

            const buyBtn = document.getElementById('buyModeBtn');
            const sellBtn = document.getElementById('sellModeBtn');
            const shopTitle = document.getElementById('shopTitleText');

            if (mode === 'buy') {
                buyBtn.classList.add('active');
                sellBtn.classList.remove('active');
                shopTitle.textContent = '🛒 Магазин карточек';
                renderShopCards();
            } else {
                sellBtn.classList.add('active');
                buyBtn.classList.remove('active');
                shopTitle.textContent = '💰 Продажа карточек';
                
                // Показываем загрузку
                showLoadingModal();
                
                // Обновляем данные пользователя перед показом карточек на продажу
                await updateUserInventory();
                
                // Скрываем загрузку и показываем карточки
                hideLoadingModal();
                renderInventoryForSale();
            }
        }

        // Парсинг инвентаря пользователя
        function parseUserInventory(cardsString) {
            if (!cardsString || cardsString === '[]' || cardsString.trim() === '') {
                return [];
            }

            let cleanString = cardsString.replace(/[\[\]"]/g, '');
            const cardsList = cleanString.split(' ')
                .map(card => card.trim())
                .filter(card => card.length > 0);

            const inventory = [];
            const cardCounts = {};

            cardsList.forEach(cardKey => {
                cardCounts[cardKey] = (cardCounts[cardKey] || 0) + 1;
            });

            Object.entries(cardCounts).forEach(([cardKey, count]) => {
                const cardData = cardsData[cardKey.toLowerCase()];
                if (cardData) {
                    for (let i = 0; i < count; i++) {
                        inventory.push({
                            key: cardKey,
                            ...cardData,
                            price: sellPrices[cardData.rarity]
                        });
                    }
                }
            });

            return inventory;
        }

        // Модальное окно
        function showBuyModal(cardKey, cardName, price) {
            if (!currentUser || currentUser.balance < price) {
                return;
            }

            pendingPurchase = { cardKey, cardName, price };
            document.getElementById('modalText').textContent = 
                `Вы уверены, что хотите купить карточку "${cardName}" за ${price} клюшек?`;
            document.getElementById('buyModal').style.display = 'block';
        }

        function closeBuyModal() {
            document.getElementById('buyModal').style.display = 'none';
            pendingPurchase = null;
        }

        function confirmPurchase() {
            if (pendingPurchase) {
                buyCard(pendingPurchase.cardKey, pendingPurchase.cardName, pendingPurchase.price);
                closeBuyModal();
            }
        }

        function showSuccessModal() {
            document.getElementById('successModal').style.display = 'block';
        }

        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
        }

        function showSellModal(cardKey, cardName, price) {
            pendingSale = { cardKey, cardName, price };
            document.getElementById('sellModalText').textContent = 
                `Продавая карту "${cardName}", вы обмениваете ее на ${price} клюшек.`;
            document.getElementById('sellModal').style.display = 'block';
        }

        function closeSellModal() {
            document.getElementById('sellModal').style.display = 'none';
            pendingSale = null;
        }

        function confirmSale() {
            if (pendingSale) {
                sellCard(pendingSale.cardKey, pendingSale.cardName, pendingSale.price);
                closeSellModal();
            }
        }

        function showSellSuccessModal() {
            document.getElementById('sellSuccessModal').style.display = 'block';
        }

        function closeSellSuccessModal() {
            document.getElementById('sellSuccessModal').style.display = 'none';
        }

        async function updateUserInventory() {
            const userId = getCookie('hockey_user_id');
            
            if (!userId) {
                addDebugLog('❌ ID пользователя не найден для обновления инвентаря', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/user/${userId}`);
                const data = await response.json();

                if (response.ok && data.user) {
                    currentUser = data.user;
                    userInventory = parseUserInventory(data.user.cards);
                    updateBalance(data.user.balance);
                    addDebugLog(`✅ Инвентарь пользователя обновлен`, 'success');
                } else {
                    addDebugLog(`❌ Ошибка обновления инвентаря: ${data.message}`, 'error');
                }
            } catch (error) {
                addDebugLog(`❌ Ошибка обновления инвентаря: ${error.message}`, 'error');
            }
        }

        async function loadUserData() {
            const userId = getCookie('hockey_user_id');

            if (!userId) {
                addDebugLog('❌ ID пользователя не найден в cookie', 'error');
                showError('Пользователь не авторизован. Вернитесь на главную страницу.');
                return;
            }

            addDebugLog(`🔄 Загрузка данных пользователя ID: ${userId}`, 'info');

            try {
                const response = await fetch(`${API_BASE}/api/user/${userId}`);
                const data = await response.json();

                if (response.ok) {
                    if (data.user) {
                        currentUser = data.user;
                        userInventory = parseUserInventory(data.user.cards);
                        renderShopCards();
                        updateBalance(data.user.balance);
                        showShop();
                        addDebugLog(`✅ Данные пользователя загружены`, 'success');
                    } else {
                        addDebugLog(`❌ Пользователь не найден: ${data.message}`, 'error');
                        showError('Пользователь не найден. Вернитесь на главную страницу.');
                    }
                } else {
                    addDebugLog(`❌ ${data.message}`, 'error');
                    showError(`Ошибка сервера: ${response.status}`);
                }
            } catch (error) {
                addDebugLog(`❌ Ошибка загрузки: ${error.message}`, 'error');
                showError('Ошибка подключения к серверу');
            }
        }

        async function buyCard(cardKey, cardName, price) {
            if (!currentUser) {
                addDebugLog('❌ Данные пользователя недоступны', 'error');
                return;
            }

            if (currentUser.balance < price) {
                addDebugLog(`❌ Недостаточно средств: ${currentUser.balance} < ${price}`, 'error');
                return;
            }

            addDebugLog(`🔄 Покупка карточки: ${cardName} за ${price} клюшек`, 'info');

            // Блокируем все кнопки на время покупки
            shopCards.forEach(card => {
                const btn = document.getElementById(`buy_${card.key}`);
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = 'Покупка...';
                }
            });

            try {
                const response = await fetch(`${API_BASE}/api/user/${currentUser.id}/buy-card`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        cardName: cardKey,
                        price: price
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addDebugLog(`✅ Карточка куплена: ${cardName}`, 'success');
                    currentUser.balance = data.user.balance;
                    updateBalance(data.user.balance);

                    // Показываем модальное окно об успешной покупке
                    showSuccessModal();
                } else {
                    addDebugLog(`❌ Ошибка покупки: ${data.message}`, 'error');
                    alert(`❌ Ошибка покупки: ${data.message}`);
                }
            } catch (error) {
                addDebugLog(`❌ Ошибка покупки: ${error.message}`, 'error');
                alert(`❌ Ошибка сети: ${error.message}`);
            }

            // Восстанавливаем кнопки
            setTimeout(() => {
                updateBalance(currentUser.balance);
            }, 1000);
        }

        // Закрытие модального окна при клике вне его
        window.onclick = function(event) {
            const buyModal = document.getElementById('buyModal');
            const successModal = document.getElementById('successModal');
            const sellModal = document.getElementById('sellModal');
            const sellSuccessModal = document.getElementById('sellSuccessModal');

            if (event.target === buyModal) {
                closeBuyModal();
            }
            if (event.target === successModal) {
                closeSuccessModal();
            }
            if (event.target === sellModal) {
                closeSellModal();
            }
            if (event.target === sellSuccessModal) {
                closeSellSuccessModal();
            }
        }

        function showLoadingModal() {
            document.getElementById('loadingModal').style.display = 'flex';
        }

        function hideLoadingModal() {
            document.getElementById('loadingModal').style.display = 'none';
        }

        // Инициализация
        window.addEventListener('load', async () => {
            addDebugLog('🚀 Запуск страницы магазина...', 'info');

            showLoadingScreen();
            initApiUrl();

            // Проверяем сервер и загружаем данные пользователя
            setTimeout(async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/test`);
                    if (response.ok) {
                        addDebugLog('✅ Сервер доступен', 'success');
                        await loadUserData();
                    } else {
                        addDebugLog('❌ Сервер недоступен', 'error');
                        showError('Сервер недоступен. Попробуйте позже.');
                    }
                } catch (error) {
                    addDebugLog(`❌ Ошибка сервера: ${error.message}`, 'error');
                    showError('Ошибка подключения к серверу');
                }
            }, 1000);
        });

        async function sellCard(cardKey, cardName, price) {
            if (!currentUser) {
                addDebugLog('❌ Данные пользователя недоступны', 'error');
                return;
            }

            addDebugLog(`🔄 Продажа карточки: ${cardName} за ${price} клюшек`, 'info');

            try {
                const response = await fetch(`${API_BASE}/api/user/${currentUser.id}/sell-card`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        cardKey: cardKey,
                        price: price
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addDebugLog(`✅ Карточка продана: ${cardName}`, 'success');
                    currentUser.balance = data.user.balance;
                    userInventory = parseUserInventory(data.user.cards);
                    updateBalance(data.user.balance);

                    // Обновляем отображение в зависимости от режима
                    if (currentMode === 'sell') {
                        renderInventoryForSale();
                    }

                    // Показываем модальное окно об успешной продаже
                    showSellSuccessModal();
                } else {
                    addDebugLog(`❌ Ошибка продажи: ${data.message}`, 'error');
                    alert(`❌ Ошибка продажи: ${data.message}`);
                }
            } catch (error) {
                addDebugLog(`❌ Ошибка продажи: ${error.message}`, 'error');
                alert(`❌ Ошибка сети: ${error.message}`);
            }
        }
    </script>
</body>
</html>
