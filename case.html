<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–µ–π—Å ‚Äî Hockey Shootouts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --accent: #f39c12;
      --accent-dark: #e67e22;
      --bg-start: #232a37;
      --bg-end: #34495e;
    }
    body {
      background: linear-gradient(135deg, var(--bg-start), var(--bg-end) 80%, var(--bg-start) 100%);
      color: #fff;
      font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;
      margin: 0; min-height: 100vh;
      -webkit-tap-highlight-color: transparent;
      animation: pagefade .6s ease both;
    }
    @keyframes pagefade {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .header-panel {
      position: fixed; left: 0; top: 0; right: 0; z-index: 100;
      background: rgba(52, 73, 94, 0.75);
      backdrop-filter: blur(8px);
      padding: 17px 18px;
      display: flex; align-items: center; justify-content: flex-start;
      box-shadow: 0 2px 18px rgba(0,0,0,0.28);
    }
    .back-btn {
      background: none; border: none; color: #fff; font-size: 19px;
      cursor: pointer; padding: 5px 13px 5px 3px; font-weight: 600;
      border-radius: 12px; transition: background 0.18s; margin-right: 7px;
    }
    .back-btn:hover { background: rgba(255,255,255,0.13);}
    .main-block {
      max-width: 400px; margin: 110px auto 0 auto;
      padding: 32px 14px 0 14px; display: flex; flex-direction: column; align-items: center;
    }
    .case-preview {
      background: rgba(255,255,255,0.09);
      border-radius: 20px; box-shadow: 0 2px 24px #0002;
      padding: 33px 22px 18px 22px;
      display: flex; flex-direction: column; align-items: center;
      animation: fadeup .7s ease both;
    }
    @keyframes fadeup {
      0% { opacity: 0; transform: translateY(20px) scale(.96); }
      60% { opacity: 1; transform: translateY(0) scale(1.03); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    .case-image {
      width: 105px; height: 105px; margin-bottom: 10px;
      border-radius: 16px; background: linear-gradient(120deg,#292d39 45%,#6c7599 100%);
      display: flex; align-items: center; justify-content: center;
      font-size: 53px; color: #f6c36e;
      border: 4px solid #f39c12;
      box-shadow: 0 2px 22px #0003;
      margin-bottom: 18px;
      position: relative;
      overflow: hidden;
    }
    .case-name { font-size: 23px; font-weight: 700; color: #f39c12; margin: 0 0 6px 0;}
    .case-desc { opacity: .82; font-size: 16px; margin-bottom: 15px; text-align: center;}
    .chance-list { width:100%; margin: 17px 0 10px 0;}
    .chance-row { display:flex; justify-content:space-between; margin-bottom: 5px; font-size: 15px;}
    .chance-dot { width:15px; height:15px; border-radius:50%; display:inline-block; margin-right:7px; vertical-align:middle;}
    .dot-rare { background: linear-gradient(135deg, #2ecc71, #27ae60);}
    .dot-superrare { background: linear-gradient(135deg, #3498db, #2980b9);}
    .dot-epic { background: linear-gradient(135deg, #9b59b6, #8e44ad);}
    .dot-mythic { background: linear-gradient(135deg,#e74c3c,#f85c77);}
    .dot-legendary { background: linear-gradient(135deg,#ffe57a,#f39c12);}
    .open-btn {
      margin: 32px 0 8px 0; background: linear-gradient(135deg,var(--accent),var(--accent-dark));
      color: #fff; border: none; font-size: 20px; font-weight: 700; border-radius: 22px;
      padding: 15px 44px; cursor: pointer;
      transition: transform .18s, box-shadow .18s, background .18s;
      box-shadow: 0 6px 24px #f39c1270;
      text-shadow: 0 1px 2px #000;
    }
    .open-btn:hover:not([disabled]) {
      transform: translateY(-2px);
      box-shadow: 0 8px 28px #f39c1277;
    }
    .open-btn:active {
      background: linear-gradient(135deg,var(--accent-dark),var(--accent));
      transform: translateY(1px);
    }
    .open-btn:focus-visible {
      outline: 2px solid #fff5;
      outline-offset: 2px;
    }
    .open-btn[disabled] { opacity: .6; cursor: not-allowed;}
    .open-btn:not([disabled]) {
      animation: btnpulse 2.4s infinite ease-in-out;
    }
    @keyframes btnpulse {
      0%,100% { box-shadow: 0 6px 24px #f39c1270; }
      50% { box-shadow: 0 6px 34px #f39c12aa; }
    }
    .timer {margin-top: 15px; color: #ffe080; font-size: 18px;}
    /* –ú–æ–¥–∞–ª–∫–∞ */
    .modal-bg {
      position: fixed; left:0; top:0; width:100vw; height:100vh;
      z-index: 9999; background: rgba(0,0,0,0.88);
      display: none; justify-content: center; align-items: center;
      opacity: 0; pointer-events: none;
      transition: opacity .2s;
      backdrop-filter: blur(3px);
    }
    .modal-bg.active {
      display: flex; opacity: 1; pointer-events: auto;
    }
    .case-modal-content {
      background: #232a37;
      border-radius: 22px; padding: 44px 26px 36px 26px;
      min-width: 290px; min-height: 210px; box-shadow: 0 8px 44px rgba(0,0,0,0.5);
      display: flex; flex-direction: column; align-items: center; position: relative;
      overflow: visible;
      transform: scale(.85);
      opacity: 0;
      transition: transform .3s cubic-bezier(.4,1,.6,1), opacity .3s;
    }
    .modal-bg.active .case-modal-content {
      transform: scale(1); opacity: 1;
    }
    /* –ö–∞—Ä—Ç–æ—á–∫–∞ –≤—Ä–∞—â–µ–Ω–∏—è */
    .spin-box {
      width: 124px; height: 124px;
      margin: 0 auto 12px auto;
      perspective: 600px; position: relative;
      display: flex; align-items: center; justify-content: center;
    }
    .spin-inner {
      width: 100%; height: 100%;
      position: absolute;
      transition: transform 1s cubic-bezier(.3,1.5,.5,1);
      transform-style: preserve-3d;
    }
    .spin-front, .spin-back {
      position:absolute; width:100%; height:100%; border-radius: 16px;
      display: flex; align-items: center; justify-content: center; backface-visibility: hidden;
      background: linear-gradient(120deg,#292d39 45%,#6c7599 100%);
      border: 5px solid #f39c12;
      box-shadow: 0 2px 34px #0006,0 0 44px #f6c36e44;
      font-size: 70px; color: #f6c36e;
      overflow: hidden;
    }
    .spin-back {
      transform: rotateY(180deg); flex-direction:column; justify-content: center;
      animation: popback .8s cubic-bezier(.4,1.7,.6,1) both;
    }
    @keyframes popback {
      0% { filter: blur(2px) brightness(2) scale(0.8); opacity:0;}
      60%{filter: blur(0.7px) brightness(1.5) scale(1.08);}
      100% { filter: none; opacity:1; }
    }
    .shine {
      position: absolute;
      width: 140px; height: 140px;
      left: 50%; top: 50%; transform: translate(-50%,-50%);
      pointer-events: none;
      background: radial-gradient(circle, #ffe57a99 0%, #fff0 80%);
      opacity: 0.5;
      animation: shine-anim 1.7s cubic-bezier(.5,1,.5,1) 1;
    }
    @keyframes shine-anim {
      0% { opacity:0; transform: translate(-50%,-50%) scale(1);}
      70%{ opacity:0.5; transform: translate(-50%,-50%) scale(1.12);}
      100% { opacity:0; transform: translate(-50%,-50%) scale(1);}
    }
    .win-img {
      width: 66px; height: 66px; border-radius: 12px; margin-bottom: 7px;
      border: 3px solid #ffe57a; box-shadow: 0 0 24px #ffe57a66;
      background: #fff2;
      object-fit: cover;
    }
    .win-name { font-size: 20px; color:#ffe080; font-weight: 700;}
    .win-rarity { font-size:15px; margin-top: 3px;}
    .close-win-btn {
      margin-top: 25px;
      background: linear-gradient(135deg,var(--accent),var(--accent-dark));
      color: white; border: none; font-size: 17px; font-weight: 700;
      border-radius: 16px; padding: 10px 32px; cursor: pointer;
      transition: background 0.18s, box-shadow 0.18s;
      box-shadow: 0 4px 18px #f39c1244;
    }
    .close-win-btn:active {
      background: linear-gradient(135deg,var(--accent-dark),var(--accent));
    }
    .error { color: #e74c3c; font-size: 18px; margin: 16px auto 0 auto; text-align: center;}
  </style>
</head>
<body>
  <div class="header-panel">
    <button class="back-btn" onclick="window.location='index.html'">‚Üê –ú–µ–Ω—é</button>
  </div>
  <div class="main-block">
    <div class="case-preview">
      <div class="case-image">üéÅ</div>
      <div class="case-name">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π</div>
      <div class="case-desc">–û—Ç–∫—Ä—ã–≤–∞–π—Ç–µ –∫–µ–π—Å –±–µ—Å–ø–ª–∞—Ç–Ω–æ —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É<br>–∏ –ø–æ–ª—É—á–∞–π—Ç–µ —Å–ª—É—á–∞–π–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É!</div>
      <div class="chance-list">
        <div class="chance-row"><span><span class="chance-dot dot-rare"></span>–†–µ–¥–∫–∏–π</span><span>60%</span></div>
        <div class="chance-row"><span><span class="chance-dot dot-superrare"></span>–°–≤–µ—Ä—Ö—Ä–µ–¥–∫–∏–π</span><span>30%</span></div>
        <div class="chance-row"><span><span class="chance-dot dot-epic"></span>–≠–ø–∏—á–µ—Å–∫–∏–π</span><span>6%</span></div>
        <div class="chance-row"><span><span class="chance-dot dot-mythic"></span>–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π</span><span>3%</span></div>
        <div class="chance-row"><span><span class="chance-dot dot-legendary"></span>–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π</span><span>1%</span></div>
      </div>
      <button class="open-btn" id="openBtn" onclick="openCase()" disabled>–û—Ç–∫—Ä—ã—Ç—å</button>
      <div class="timer" id="timer" style="display:none;"></div>
      <div class="error" id="errorText"></div>
    </div>
  </div>

  <div class="modal-bg" id="caseModal">
    <div class="case-modal-content">
      <div class="spin-box" id="spinBox">
        <div class="spin-inner" id="spinInner">
          <div class="spin-front" id="spinFront">
            <span class="spin-mark" style="font-size:68px;">‚ùì</span>
          </div>
          <div class="spin-back" id="spinBack">
            <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ—è–≤–∏—Ç—Å—è —Ç—É—Ç -->
          </div>
        </div>
      </div>
      <button class="close-win-btn" style="margin-top:8px;display:none;" id="closeBtn" onclick="closeModal()">–ó–∞–±—Ä–∞—Ç—å</button>
    </div>
  </div>

  <script>
    // Rarity —Ü–≤–µ—Ç–∞ –∏ ru-–∏–º–µ–Ω–∞
    const rarityConfig = {
      rare:      { ru: '–†–µ–¥–∫–∏–π',      class:'dot-rare' },
      superrare: { ru: '–°–≤–µ—Ä—Ö—Ä–µ–¥–∫–∏–π', class:'dot-superrare' },
      epic:      { ru: '–≠–ø–∏—á–µ—Å–∫–∏–π',  class:'dot-epic' },
      mythic:    { ru: '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π', class:'dot-mythic' },
      legendary: { ru: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π',class:'dot-legendary' }
    };
    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) == 0) {
          return c.substring(nameEQ.length, c.length);
        }
      }
      return null;
    }

    // –ü–æ–ª—É—á–∞–µ–º userId
    let userId = getCookie('hockey_user_id');

    async function updateTimer() {
      const timer = document.getElementById('timer');
      const openBtn = document.getElementById('openBtn');
      timer.style.display = 'none';
      openBtn.disabled = true;
      document.getElementById('errorText').textContent = '';
      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä: –∫–æ–≥–¥–∞ –º–æ–∂–Ω–æ —Å–Ω–æ–≤–∞
      if (!userId) return;
      let canOpen = true;
      let wait = 0;
      try {
        const res = await fetch(`/api/user/${userId}`);
        const data = await res.json();
        if (data && data.user && data.user.case_free) {
          const now = Date.now();
          if (now < Number(data.user.case_free)) {
            wait = Math.ceil((Number(data.user.case_free)-now)/1000);
            canOpen = false;
          }
        }
      } catch {}
      if (!canOpen && wait>0) {
        openBtn.disabled = true;
        timer.style.display = '';
        timer.textContent = `–ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ ${wait>59?Math.floor(wait/60)+'–º ':''
          }${wait%60}—Å`;
        setTimeout(updateTimer, 900);
      } else {
        openBtn.disabled = false;
        timer.style.display = 'none';
      }
    }

    async function openCase() {
      if (!userId) return;
      const openBtn = document.getElementById('openBtn');
      const error = document.getElementById('errorText');
      error.textContent = '';
      openBtn.disabled = true;

      // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Å –≤—Ä–∞—â–∞—é—â–∏–º—Å—è –≤–æ–ø—Ä–æ—Å–æ–º
      const modal = document.getElementById('caseModal');
      const spinInner = document.getElementById('spinInner');
      const spinBack = document.getElementById('spinBack');
      const closeBtn = document.getElementById('closeBtn');
      spinBack.innerHTML = '';
      spinInner.style.transform = 'rotateY(0deg)';
      closeBtn.style.display = 'none';
      modal.classList.add('active');

      // –í—Ä–∞—â–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ (CSS)
      spinInner.style.transition = 'none';
      spinInner.style.transform = 'rotateY(0deg)';
      setTimeout(()=>{spinInner.style.transition='transform 1s cubic-bezier(.3,1.5,.5,1)';},20);

      // –ñ–¥—ë–º –∞–Ω–∏–º–∞—Ü–∏—é, –∑–∞—Ç–µ–º ‚Äî —Å–µ—Ä–≤–µ—Ä
      setTimeout(async ()=>{
        let card = null, wait = 0;
        try {
          const res = await fetch(`/api/user/${userId}/free-case`, { method:'POST' });
          const data = await res.json();
          if (data.status === 'error') {
            error.textContent = data.message || '–û—à–∏–±–∫–∞!';
            modal.classList.remove('active');
            openBtn.disabled = false;
            updateTimer();
            return;
          }
          card = data.card;
          wait = data.next_sec || 60;
        } catch(e) {
          error.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞!";
          modal.classList.remove('active');
          openBtn.disabled = false;
          updateTimer();
          return;
        }

        // –ì–æ—Ç–æ–≤–∏–º –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const rConf = rarityConfig[card.rarity] || {ru:card.rarity,class:''};
        spinBack.innerHTML = `
          <div class="shine"></div>
          <img src="https://raw.githubusercontent.com/ChatGPT-Course/Xokkey/main/avatar/${card.name}.jpg"
            class="win-img" alt="${card.name}" onerror="this.src='https://via.placeholder.com/66x66?text=?'">
          <div class="win-name">${card.name}</div>
          <div class="win-rarity"><span class="chance-dot ${rConf.class}"></span> ${rConf.ru}</div>
        `;
        // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
        spinInner.style.transform = 'rotateY(180deg)';
        setTimeout(()=>{ closeBtn.style.display = 'block'; },600);
        // –ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–±–Ω–æ–≤–∏–º —Ç–∞–π–º–µ—Ä (–ø–æ —Å–µ—Ä–≤–µ—Ä—É!)
        setTimeout(updateTimer, 1000);
      }, 1200);
    }

    function closeModal() {
      document.getElementById('caseModal').classList.remove('active');
      document.getElementById('closeBtn').style.display = 'none';
    }

    window.onload = function() {
      updateTimer();
    }
  </script>
</body>
</html>
